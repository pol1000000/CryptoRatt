{% extends "base.html" %}
{% load static from staticfiles %}
{% load i18n %}
{% load cred_markdown %}
{% load credicons %}

{% block title %}{{ cred.title }} - {% trans "Rattic" %}{% endblock %}

{% block headarea %}
  <meta name="rattic_cred_id" content="{{ cred.id }}" />
{% endblock %}

{% block content %}

{% if delete %}
  <div class="alert alert-danger mt-2" role="alert">
    {% blocktrans %}You are about to delete this password. A staff member will be required if you want to undelete it.{% endblocktrans %}
  </div>
{% endif %}
{% if cred.is_deleted and cred.is_latest %}
  <div class="alert alert-danger mt-2" role="alert">
    {% blocktrans %}This credential has been deleted and is in the trash can. It is only visible to staff. You can alter it if you wish, its history will still be recorded. Click the undelete button to restore it. If you click the Delete Permanently button then the password, its entire history and all its audit logs will be removed.{% endblocktrans %}
  </div>
{% endif %}
{% if not cred.is_latest %}
  <div class="alert alert-info mt-2" role="alert">
    <strong>{% trans "Hey there!" %}</strong>
    {% blocktrans %}This credential is an historical version.{% endblocktrans %} <a href="{% url 'cred:cred_detail' cred.latest.id %}">{% trans "Click here" %}</a> {% blocktrans %}to see the latest version.{% endblocktrans %}
  </div>
{% endif %}
{% if cred.on_changeq and not readonly %}
  <div class="alert alert-warning mt-2" role="alert">
    <strong>{% trans "Change Required" %}</strong>
    {% blocktrans %}This credential is on the change queue and should have its password changed as soon as possible.{% endblocktrans %} {% trans "Why not" %} <a href="{% url "cred:cred_edit" cred.id %}">{% trans "do it now" %}</a>{% trans "?" %}
  </div>
{% endif %}
{% if cred.is_expired %}
  <div class="alert alert-warning mt-2" role="alert">
    <strong>{% trans "Hey there!" %}</strong>
    {% blocktrans %}  Looks like this credential is expired! So it should won`t work!{% endblocktrans %}
  </div>
{% endif %}

<div class="row pt-2">
  <div class="col-md-1 d-flex flex-wrap align-items-center">
    <img class="mx-auto d-block img-thumbnail" style="width: 64px;" alt="{% trans "RatticDB Logo" %}" src="{% static rattic_logo %}"/>
  </div>
  <div class="col-md-8">
    <div class="row">
      <div class="col-md-12">
        <div class="well">
          <h3>{{ cred.title }}</h3>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div class="well">
          {% if cred.url %}
            <a href="{{ cred.url }}">{{ cred.url }}</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{% if cred.is_latest and not readonly %}
  <div class="pb-2 pt-2 btn-group" role="group" aria-label="credential-tools-buttons">
    <a class="btn btn-primary" href="{% url 'cred:cred_edit' cred.id %}" role="button">{% trans "Edit" %}</a>
    <a class="btn btn-secondary" href="{% url 'cred:cred_list' 'history' cred.id 'ascending' 'id' %}" role="button">{% trans "History" %}</a>
    {% if not delete %}
      <a class="btn btn-danger" href="{% url 'cred:cred_delete' cred.id %}" role="button">{% trans "Delete" %}</a>
    {% endif %}
    {% if not cred.is_deleted %}
      <a class="btn btn-info" href="{% url 'cred:cred_add_to_queue' cred.id %}" role="button">{% trans "Change Queue" %}</a>
    {% endif %}
    {% if cred.is_deleted and not undelete %}
      <a class="btn btn-success" href="{% url 'staff:cred_undelete' cred.id %}" role="button">{% trans "Undelete" %}</a>
    {% endif %}
  </div>
{% endif %}

<div class="table-responsive">
  <table class="table table-striped">
  {% if cred.project %}
    <tr>
      <th>{% trans "Project" %}</th>
      <td>
        <h5><a href="{% url "cred:project_detail" cred.project.id %}" class="">{{ cred.project.title }}</a><h5>
      </td>
    </tr>
  {% endif %}
  
  <tr>
    <th>{% trans "Username" %}</th>
    <td id="usertd" class="rattic-copy-button">
      {% if cred.username %}
        <span id="username">{{ cred.username }}</span>
        <button class="btn btn-primary btn-sm" id="js-copy-name" data-clipboard-target="#username">Copy</button>
      {% endif %}
    </td>
  </tr>

  <tr>
    <th>
        {% trans "Password" %}
        <button class="btn btn-primary btn-sm btn-password-show-hide btn-pass-fetchcred" data-target="#password"></button>
    </th>
    <td id="passtd" class="rattic-copy-button">
      <span id="password" class="passhidden">Fetching Password...</span>
      <button class="btn btn-primary btn-sm" id="js-copy-passwd" data-clipboard-target="#password">Copy</button>
    </td>
  </tr>

  <tr>
    <th>
      {% trans "Owner Group" %}
    </th>
    <td>
      {% if cred.group in groups.all or user.is_staff %}
        <a href="{% url 'cred:cred_list' 'group' cred.group.id %}">{{ cred.group.name }}</a>
      {% else %}
        {{ cred.group.name }}
      {% endif %}
    </td>
  </tr>
  <tr>
    <th>{% trans "Viewer Groups" %}</th>
      <td>
        {% for g in cred.groups.all %}
          {% if g in groups.all or user.is_staff %}
            <a href="{% url 'cred:cred_list' 'group' g.id %}">{{ g.name }}</a>
          {% else %}
            {{ g.name }}
          {% endif %}
          {% if not forloop.last %},{% endif %}
        {% endfor %}
      </td>
  </tr>
  {% if not cred.users %}
    <tr>
      <th>{% trans "Viewer Users" %}</th>
        <td>
          {% for u in cred.users.all %}
            {% if u in users.all or user.is_staff %}
              <a href="{% url "staff:audit" "user" u.id %}">{{ u.username }}</a>
            {% else %}
              {{ u.username }}
            {% endif %}
            {% if not forloop.last %},{% endif %}
          {% endfor %}
        </td>
    </tr>
  {% endif %}
  {% if not cred.tags %}
    <tr>
      <th>{% trans "Tags" %}</th>
      <td>
        {% for t in cred.tags.all %}
          <a class="badge badge-primary" href="{% url 'cred:cred_list' 'tag' t.id %}">{{ t.name }}</a>
        {% endfor %}
      </td>
    </tr>
  {% endif %}
  <tr><th>{% trans "Last Changed" %}</th><td>{{ cred.modified }}</td></tr>
  <tr><th>{% trans "Created" %}</th><td>{{ cred.created }}</td></tr>
  </table>
</div>

{% if cred.description|length %}
  <div class="card mt-2">
    <div class="card-header">
      {% trans "Description" %}
    </div>
    <div class="card-body">
    {% if cred.descriptionmarkdown %}
      {% markdown_cred cred.description %}
    {% else %}
      {{ cred.description }}
    </div>
    {% endif %}
  </div>
{% endif %}
  
{% if attachments %}
  <div class="card pt-2">
    <div class="card-header">
      {% trans "Attachments" %}
    </div>
    <ul class="list-unstyled">
      {% for a in attachments.all %}
        <li>
          <a class="badge badge-primary mt-2 ml-2" href="{% url 'cred:download_attachment' a.id %}" role="button">{{ a.filename }}</a>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}


{% comment %} {% if delete %}
    <form action="" method="post">{% csrf_token %}
        <input type="submit" class="btn btn-danger" value="{% trans "Delete" %}" />
    </form>
{% endif %}
{% if undelete %}
    <form action="" method="post">{% csrf_token %}
        <input type="submit" class="btn btn-success" value="{% trans "Undelete" %}" />
    </form>
{% endif %}
{% if not delete %}
    {% if credlogs %}
        {% include "credaudit_list.html" with type='user' %}
    {% endif %}
{% endif %} {% endcomment %}

{% endblock %}
